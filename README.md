# Gmail → Notion → Slack 通知（GAS）

Gmailで受信した特定メールをNotionデータベースへ登録し、NotionのオートメーションからSlackへ通知する構成です。Slackの無料枠（外部連携10個制限）を回避するため、Notionを中継にしています。

- 抽出はGAS（時間トリガー/手動）
- 登録先はNotion DB（ルールごと）
- Slack通知はNotion側のオートメーションで実施
- 再通知判定は「メッセージID」で行い、同一メールは一度だけ登録（ラベル判定は廃止）

---

## セットアップ手順

### 1) Notionの準備
1. NotionでInternal Integrationを作成し、シークレットトークンを取得
2. 登録先としたい親ページを開き、Integrationを「共有」に招待（権限付与）
3. 親ページURLからページID（32桁）を控える

### 2) スプレッドシートの初期化
- スプレッドシートを開く → メニュー「メール通知システム」→「設定シートを再生成」
- シートが生成されます：
  - システム設定
  - メール通知設定
  - 通知ログ
  - 抽出デバッグ（実行時に自動）

### 3) システム設定
- NOTION_TOKEN: 手順1のトークン
- DEFAULT_PARENT_PAGE_ID: Notionの親ページID（またはURL）
- SINCE_DATE: 抽出基準日（例: 2025/08/01）

### 4) メール通知設定（行ごとにルール）
| 列名 | 説明 |
|---|---|
| 件名キーワード | 件名の部分一致（空欄可） |
| アドレス（完全一致） | 送信元メールアドレスの完全一致（空欄可） |
| 処理済みGmailラベル名 | 廃止済みの判定用（列は残す／用途分類に利用可） |
| Notion DB ID | 既存DBを使う場合に指定。空欄なら親ページ配下に自動作成 |
| 備考（任意） | 管理用メモ |
| 除外キーワード（任意） | 件名に含まれると除外（カンマ・空白区切り複数可） |

- 一致条件: 件名・送信元のいずれかが指定されていれば対象。両方ある場合は AND 条件
- 除外語: 件名に含まれる場合は除外

### 5) 実行
- 手動: メニュー「メール通知システム」→「手動で通知実行」
- 定期: メニュー「毎時トリガーを再作成」（1時間ごと）

---

## 処理の流れ（概要）
1. Gmail検索で母集団抽出（`after:` と `from:`、`-subject:"除外語"` など）
2. スレッド内の各メッセージを走査
3. ルールに一致するか判定（件名の部分一致＋送信元完全一致＋除外語不一致）
4. 通知ログに同じ「メッセージID」が無いか確認（重複防止）
5. 未処理のみNotionへページ作成 → ログへ記録（メッセージID含む）

- ラベルによる判定/付与は廃止（列は残存）
- Notion DBが未指定なら、親ページ配下に自動作成（同一スキーマ）
- Notion DBのプロパティ（共通）
  - 件名（title）
  - 受信日時（date）
  - 実行日時（date）
  - 送信者（rich_text）
  - 本文（rich_text, プレーンテキスト）

---

## デバッグとログ

### 抽出デバッグ（シート）
- 列: ルール行 / クエリ / ヒット件数(上限100) / 件名キーワード / サンプル件名 / サンプル送信元 / サンプル受信日時 / 備考 / 抽出日 / マッチ件数(フィルタ後)
- ヒット件数: Gmail検索の母集団
- マッチ件数: ルール判定適用後（実際の登録対象数）

### 通知ログ（シート）
- 列: 実行日時 / メール受信日時 / 件名 / 送信者 / メッセージID / DB ID / ステータス / エラーメッセージ / 備考
- メッセージIDで重複を防止（同じIDは再通知しない）

---

## よくあるトラブル
- Notionでエラー: トークン未設定/対象ページにIntegration未招待 → 招待・権限確認
- 抽出0件: `SINCE_DATE`が未来・件名や送信元が厳しすぎる・除外語に該当
- 二重登録: ログの「メッセージID」列が削除/欠損していないか確認
- 時差: Notionへはスクリプトのタイムゾーン（JST）でRFC3339送信

---

## 将来の拡張
- Notionページに@メンションを付与（n8nなどでワークフロー拡張）
- LINE通知・再通知キュー・曜日/時間帯制御 など

---

## 運用コマンド（開発者向け）
- デプロイ（GAS反映）: `clasp push`
- Git運用:
  - 変更 → `git add -A` → `git commit -m "msg"` → `git push`

---

## ライセンス
- プロジェクト内のソースは私的利用を前提としています。必要に応じて適宜追記してください。
